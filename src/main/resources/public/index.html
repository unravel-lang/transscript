<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>WebDAV æ–‡ä»¶ç›‘æ§</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

</head>
<body>
<h2>ç½‘ç›˜æ–‡ä»¶åˆ—è¡¨ (å®æ—¶æ›´æ–°)</h2>
<ul id="file-list"></ul>

<div id="breadcrumb">
    <button onclick="goBack()">è¿”å›ä¸Šä¸€çº§</button>
    <span id="path-display">/</span>
</div>
<table border="1">
    <thead>
    <tr>
        <th>åç§°</th>
        <th>ç±»å‹</th>
        <th>å¤§å°</th>
        <th>ä¿®æ”¹æ—¶é—´</th>
    </tr>
    </thead>
    <tbody id="file-table-body"></tbody>
</table>
<script>
    const socket = new SockJS('/ws-endpoint');
    const stompClient = Stomp.over(socket);

    stompClient.connect({}, function (frame) {
        console.log('Connected: ' + frame);
        // è®¢é˜…åç«¯æ¨é€çš„æ¶ˆæ¯
        stompClient.subscribe('/topic/files', function (message) {
            const files = JSON.parse(message.body);
            updateUI(files);
        });
    });

    function updateUI(files) {
        const listElement = document.getElementById('file-list');
        listElement.innerHTML = '';
        files.forEach(file => {
            const li = document.createElement('li');
            li.textContent = file;
            listElement.appendChild(li);
        });
    }
    let currentPath = "/";

    // åŠ è½½æŒ‡å®šè·¯å¾„çš„æ–‡ä»¶
    async function loadFiles(path) {
        currentPath = path;
        document.getElementById('path-display').innerText = path;

        const response = await fetch(`/api/files?path=${encodeURIComponent(path)}`);
        const files = await response.json();
        renderTable(files);
    }

    function formatBytes(size) {
        // æ ¼å¼åŒ–æ–‡ä»¶size
        if (size < 1024) return size + " B";
        const units = ["KB", "MB", "GB", "TB"];
        let unitIndex = 0;
        while (size >= 1024 && unitIndex < units.length - 1) {
            size /= 1024;
            unitIndex++;
        }
        return size.toFixed(2) + " " + units[unitIndex];
    }

    function renderTable(files) {
        const tbody = document.getElementById('file-table-body');
        tbody.innerHTML = '';

        files.forEach(file => {
            const tr = document.createElement('tr');
            // å¦‚æœæ˜¯æ–‡ä»¶å¤¹ï¼Œç‚¹å‡»åç§°è°ƒç”¨ loadFiles
            const nameHtml = file.isDirectory
                ? `<a href="#" onclick="loadFiles('${file.path}')">ğŸ“ ${file.name}</a>`
                : `ğŸ“„ ${file.name} <button onclick="downloadFile('${file.path}')">ä¸‹è½½</button>`;

            tr.innerHTML = `
            <td>${nameHtml}</td>
            <td>${file.isDirectory ? 'æ–‡ä»¶å¤¹' : 'æ–‡ä»¶'}</td>
            <td>${file.isDirectory ? '-' : formatBytes(file.size)}</td>
            <td>${file.lastModified}</td>
        `;
            tbody.appendChild(tr);
        });
    }

    function goBack() {
        if (currentPath === "/") return;
        const parts = currentPath.split('/').filter(Boolean);
        parts.pop();
        loadFiles("/" + parts.join('/'));
    }


    function downloadFile(filePath) {
        // ç›´æ¥è·³è½¬æˆ–å¼€æ–°çª—å£ï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨è¯†åˆ« attachment å“åº”å¤´å¹¶å¼€å§‹ä¸‹è½½
        window.location.href = `/api/download?path=${encodeURIComponent(filePath)}`;
    }
    // åˆå§‹åŠ è½½
    loadFiles("/");

</script>
</body>
</html>